<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UlisChat</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        /* [Existing styles remain unchanged] */
    </style>
</head>
<body>
    <div id="error-message"></div>
    <div id="sidebar">
        <h3>Online Users (<span id="user-count">0</span>)</h3>
        <ul id="user-list"></ul>
    </div>
    <div id="chat-container">
        <div id="header">
            <span id="current-username">Loading...</span>
            <div class="controls">
                <a href="#" onclick="changeUsername(event)">Change Username</a>
                <a href="#" onclick="showColorPicker(event)">Change Color</a>
                <a href="#" onclick="logout(event)">Logout</a>
            </div>
        </div>
        <div id="tabs">
            <button class="tab-button active" data-tab="main" onclick="switchTab('main')">Main Chat</button>
        </div>
        <div id="chat-area-container">
            <div id="chat-area" class="chat-area active">
                <div class="chat-content"></div>
            </div>
            <div id="dm-tabs"></div>
        </div>
        <div id="input-container">
            <div id="typing-indicator" class="typing-indicator"></div>
            <div id="input-area">
                <input type="text" id="message-input" placeholder="Type a message..." oninput="handleTyping()" onkeydown="if(event.key === 'Enter') sendMessage(event)">
                <select id="language-select" onchange="updateLanguage(event)">
                    <option value="en">English</option>
                    <option value="fr">French</option>
                    <option value="es">Spanish</option>
                    <option value="pt">Portuguese</option>
                    <option value="ru">Russian</option>
                    <option value="hi">Hindi</option>
                </select>
                <input type="file" id="image-input" accept="image/*" onchange="sendImage(event)">
                <button id="send-button" onclick="sendMessage(event)">Send</button>
                <button id="image-button" onclick="document.getElementById('image-input').click()">Image</button>
            </div>
        </div>
        <div id="color-picker-modal">
            <div id="color-picker-content">
                <h3>Choose Your Color</h3>
                <input type="color" id="color-picker" value="#1E90FF">
                <br><br>
                <button onclick="changeColor(event)">Save</button>
                <button onclick="hideColorPicker(event)">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io('/chat', { reconnection: true, reconnectionAttempts: 5, reconnectionDelay: 1000 });
        let username = '', userColor = '#1E90FF', userLanguage = 'en', activeTab = 'main', dmTabs = {}, replyTo = null;
        const connectedUsers = {};

        socket.on('connect', () => console.log('Socket.IO connected successfully'));
        socket.on('connect_error', (err) => {
            console.error('Socket.IO connection error:', err.message);
            showError('Connection to server failed. Attempting to reconnect...');
            setTimeout(() => socket.connect(), 1000);
        });
        socket.on('disconnect', () => console.warn('Socket.IO disconnected'));

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function initializeUser() {
            fetch('/user', { method: 'GET', credentials: 'include' })
                .then(res => {
                    if (!res.ok) {
                        if (res.status === 401) {
                            console.log('Not logged in, redirecting to /');
                            window.location.href = '/?nocache=' + Date.now();
                            return;
                        }
                        throw new Error(`HTTP error! Status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error('User fetch error:', data.error);
                        showError('Not logged in. Redirecting to login...');
                        window.location.href = '/?nocache=' + Date.now();
                        return;
                    }
                    username = data.username || 'Anonymous';
                    userColor = data.color || '#1E90FF';
                    userLanguage = data.language || 'en';
                    document.getElementById('current-username').textContent = `Welcome, ${username}`;
                    document.getElementById('language-select').value = userLanguage;
                    updateColorStyle();
                    console.log('User initialized:', { username, userColor, userLanguage });

                    socket.emit('chat message', { username: 'System', text: `${username} has joined`, id: Date.now().toString() });
                    loadHistory();
                })
                .catch(err => {
                    console.error('Fetch /user error:', err.message);
                    showError('Failed to load user data. Redirecting to login...');
                    window.location.href = '/?nocache=' + Date.now();
                });
        }

        initializeUser();

        socket.on('user count', count => {
            console.log('User count updated:', count);
            document.getElementById('user-count').textContent = count || 0;
        });

        socket.on('user list', users => {
            console.log('User list updated:', users);
            users.forEach(user => {
                connectedUsers[user.id] = user;
            });
            const ul = document.getElementById('user-list');
            ul.innerHTML = users
                .filter(u => u.username !== username)
                .map(u => `<li style="color: ${u.color || '#1E90FF'}" onclick="startDM('${u.id}', '${u.username}')">${u.username || 'Anonymous'}</li>`)
                .join('');
        });

        socket.on('chat message', msg => {
            console.log('Received chat message:', msg);
            handleMessage(msg, document.getElementById('chat-area').querySelector('.chat-content'), false);
        });

        socket.on('dm message', msg => {
            console.log('Received DM message:', msg);
            const recipientId = msg.recipientId === socket.id ? msg.senderId : msg.recipientId;
            let tab = dmTabs[recipientId];
            if (!tab) {
                const recipientUsername = msg.username === username ? getRecipientUsername(recipientId) : msg.username;
                createDMTab(recipientId, recipientUsername);
                tab = dmTabs[recipientId];
            }
            handleMessage(msg, tab.chat, true);
            saveMessage(msg, recipientId);
        });

        socket.on('typing', username => updateTypingIndicator(username));
        socket.on('stop typing', () => updateTypingIndicator(''));
        socket.on('name change', data => updateNameChange(data));
        socket.on('color change', data => {
            if (data.id === socket.id) {
                userColor = data.color;
                updateColorStyle();
            }
            updateUserColor(data);
        });

        function handleMessage(msg, chat, isDM) {
            if (!chat) {
                console.error('Chat container not found for message:', msg);
                return;
            }
            console.log('Handling message for chat:', chat.id, 'Message:', msg);
            const div = document.createElement('div');
            div.className = `message ${msg.username === username ? 'sent' : 'received'}`;
            div.dataset.id = msg.messageId || msg.id;
            div.dataset.senderId = msg.senderId || '';
            const usernameColor = msg.username === username ? userColor : (msg.color || '#1E90FF');
            div.style.setProperty('--username-color', usernameColor);

            const usernameSpan = document.createElement('span');
            usernameSpan.className = 'username';
            usernameSpan.textContent = msg.username === username ? 'You' : (msg.username || 'Anonymous');
            div.appendChild(usernameSpan);

            let text = msg.text || '';
            if (msg.language !== userLanguage && text && !msg.image) {
                fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${msg.language}|${userLanguage}`)
                    .then(res => res.json())
                    .then(data => {
                        text = data.responseStatus === 200 ? data.responseData.translatedText : text;
                        updateMessageContent(div, text, msg.image);
                    })
                    .catch(e => {
                        console.error('Translation error:', e);
                        updateMessageContent(div, text, msg.image);
                    });
            } else {
                updateMessageContent(div, text, msg.image);
            }

            if (msg.replyTo) {
                const reply = document.createElement('div');
                reply.className = 'reply-context';
                reply.innerHTML = `<span class="reply-username">${msg.replyTo.username}</span><span class="reply-text">${msg.replyTo.text}</span>`;
                div.insertAdjacentElement('afterbegin', reply);
            }
            if (msg.language !== userLanguage && text && !msg.image) {
                const orig = document.createElement('div');
                orig.className = 'meta';
                orig.textContent = `(${msg.language}: ${msg.text})`;
                div.appendChild(orig);
            }
            const replyBtn = document.createElement('span');
            replyBtn.textContent = 'Reply';
            replyBtn.className = 'meta';
            replyBtn.style.color = '#4ecdc4';
            replyBtn.onclick = () => setReply(msg);
            div.appendChild(replyBtn);

            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            saveMessage(msg, isDM ? getRecipientId(chat) : null);
        }

        function updateMessageContent(div, text, image) {
            const content = image ? `<img src="${image}" alt="Image">` : text;
            div.innerHTML = `${div.querySelector('.username')?.outerHTML || ''}<span class="meta">${div.querySelector('.meta')?.textContent || ''}</span>${content}${div.querySelector('.reply-context') ? div.querySelector('.reply-context').outerHTML : ''}${div.querySelector('.replyBtn') ? div.querySelector('.replyBtn').outerHTML : ''}`;
        }

        function getRecipientId(chat) {
            return Object.keys(dmTabs).find(id => dmTabs[id].chat === chat);
        }

        function getRecipientUsername(id) {
            return connectedUsers[id]?.username || 'Anonymous';
        }

        function updateTypingIndicator(username) {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.textContent = username ? `${username} is typing...` : '';
        }

        function updateNameChange(data) {
            if (data.oldUsername === username) username = data.newUsername;
            document.getElementById('current-username').textContent = `Welcome, ${username}`;
            ['chat-area', ...Object.values(dmTabs).map(t => t.chat)].forEach(chat => {
                const div = document.createElement('div');
                div.className = 'meta';
                div.style.color = '#7f8c8d';
                div.textContent = `${data.oldUsername} changed to ${data.newUsername}`;
                chat.appendChild(div);
                chat.scrollTop = chat.scrollHeight;
            });
        }

        function updateUserColor(data) {
            const userLi = document.querySelector(`#user-list li[onclick*="startDM('${data.id}')"]`);
            if (userLi) userLi.style.color = data.color;
            connectedUsers[data.id].color = data.color;
            document.querySelectorAll('.message.received').forEach(msg => {
                if (msg.dataset.senderId === data.id) {
                    msg.style.setProperty('--username-color', data.color);
                    msg.querySelector('.username').style.color = data.color;
                }
            });
        }

        function startDM(recipientId, recipientUsername) {
            if (!dmTabs[recipientId]) {
                createDMTab(recipientId, recipientUsername);
            }
            switchTab(`dm-${recipientId}`);
        }

        function createDMTab(recipientId, recipientUsername) {
            const tabs = document.getElementById('tabs');
            const tabBtn = document.createElement('button');
            tabBtn.className = 'tab-button';
            tabBtn.setAttribute('data-tab', `dm-${recipientId}`);
            tabBtn.textContent = `DM: ${recipientUsername}`;
            tabBtn.onclick = () => switchTab(`dm-${recipientId}`);
            tabs.appendChild(tabBtn);

            const dmTab = document.createElement('div');
            dmTab.id = `dm-${recipientId}`;
            dmTab.className = 'chat-area';
            dmTab.innerHTML = `<div id="chat-${recipientId}" class="chat-content"></div>`;
            document.getElementById('dm-tabs').appendChild(dmTab);

            dmTabs[recipientId] = {
                chat: document.getElementById(`chat-${recipientId}`),
                button: tabBtn
            };
            loadDMHistory(recipientId);
        }

        function switchTab(tabId) {
            console.log('Switching to tab:', tabId);
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.chat-area').forEach(area => {
                area.classList.remove('active');
                area.style.visibility = 'hidden';
                area.style.display = 'none';
            });

            const tabButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (tabButton) tabButton.classList.add('active');

            const chatArea = tabId === 'main' ? document.getElementById('chat-area') : document.getElementById(tabId);
            if (chatArea) {
                chatArea.classList.add('active');
                chatArea.style.display = 'flex';
                chatArea.style.visibility = 'visible';
                const chatContent = chatArea.querySelector('.chat-content');
                if (chatContent) chatContent.scrollTop = chatContent.scrollHeight;
            } else {
                console.error('Chat area not found for tab:', tabId);
            }

            activeTab = tabId;
            const input = document.getElementById('message-input');
            const recipientId = tabId.startsWith('dm-') ? tabId.replace('dm-', '') : '';
            input.dataset.recipient = recipientId;
            input.disabled = false;
            input.focus();
            input.placeholder = recipientId ? `DM to ${getRecipientUsername(recipientId)}...` : 'Type a message...';
            replyTo = null;
            updateTypingIndicator('');
        }

        function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            if (input.disabled) {
                console.log('Input is disabled, cannot send message');
                return;
            }
            const text = input.value.trim();
            if (!text) {
                console.log('No text to send');
                return;
            }
            const recipientId = input.dataset.recipient || '';
            const msg = { username: username || 'Anonymous', text, color: userColor, language: userLanguage, id: (Date.now() + Math.random().toString(36).substr(2, 9)).toString(), senderId: socket.id };
            if (replyTo) { msg.replyTo = { username: replyTo.username, text: replyTo.text }; replyTo = null; }
            if (recipientId) {
                msg.recipientId = recipientId;
                socket.emit('dm message', msg);
                console.log('Sent DM message:', msg);
            } else {
                socket.emit('chat message', msg);
                console.log('Sent main chat message:', msg);
            }
            input.value = '';
            socket.emit('stop typing');
        }

        function sendImage(e) {
            e.preventDefault();
            const file = document.getElementById('image-input').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const msg = { username: username || 'Anonymous', image: e.target.result, color: userColor, language: userLanguage, id: (Date.now() + Math.random().toString(36).substr(2, 9)).toString(), senderId: socket.id };
                const recipientId = document.getElementById('message-input').dataset.recipient || '';
                if (replyTo) { msg.replyTo = { username: replyTo.username, text: replyTo.text }; replyTo = null; }
                if (recipientId) {
                    msg.recipientId = recipientId;
                    socket.emit('dm message', msg);
                    console.log('Sent DM image:', msg);
                } else {
                    socket.emit('chat message', msg);
                    console.log('Sent main chat image:', msg);
                }
                document.getElementById('image-input').value = '';
            };
            reader.readAsDataURL(file);
        }

        function handleTyping() {
            socket.emit('typing', username || 'Anonymous');
            clearTimeout(window.typingTimeout);
            window.typingTimeout = setTimeout(() => socket.emit('stop typing'), 1000);
        }

        function changeUsername(e) {
            e.preventDefault();
            const newName = prompt('New username:');
            if (newName && newName.trim()) {
                fetch('/change-username', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newUsername: newName.trim() }),
                    credentials: 'include'
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            socket.emit('name change', { oldUsername: username, newUsername: newName.trim(), id: socket.id });
                            username = newName.trim();
                            document.getElementById('current-username').textContent = `Welcome, ${username}`;
                            console.log('Username changed:', newName);
                        } else {
                            showError(data.message || 'Failed to change username');
                        }
                    })
                    .catch(err => {
                        console.error('Change username error:', err);
                        showError('Error changing username');
                    });
            }
        }

        function showColorPicker(e) {
            e.preventDefault();
            document.getElementById('color-picker-modal').style.display = 'block';
            document.getElementById('color-picker').value = userColor;
        }

        function hideColorPicker(e) {
            e.preventDefault();
            document.getElementById('color-picker-modal').style.display = 'none';
        }

        function changeColor(e) {
            e.preventDefault();
            const newColor = document.getElementById('color-picker').value;
            fetch('/change-color', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ color: newColor }),
                credentials: 'include'
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        userColor = newColor;
                        socket.emit('color change', { id: socket.id, color: newColor });
                        updateColorStyle();
                        console.log('Color changed:', newColor);
                    } else {
                        showError(data.message || 'Failed to change color');
                    }
                })
                .catch(err => {
                    console.error('Change color error:', err);
                    showError('Error changing color');
                });
        }

        function updateLanguage(e) {
            e.preventDefault();
            userLanguage = document.getElementById('language-select').value;
            fetch('/update-language', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ language: userLanguage }),
                credentials: 'include'
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) showError(data.message || 'Failed to update language');
                })
                .catch(err => {
                    console.error('Update language error:', err);
                    showError('Error updating language');
                });
        }

        function logout(e) {
            e.preventDefault();
            fetch('/logout', { credentials: 'include' })
                .then(res => {
                    if (res.ok) {
                        window.location.href = '/?nocache=' + Date.now();
                    } else {
                        showError('Logout failed');
                    }
                })
                .catch(err => {
                    console.error('Logout error:', err);
                    showError('Error logging out');
                });
        }

        function setReply(msg) {
            replyTo = msg;
            document.getElementById('message-input').placeholder = `Replying to ${msg.username}: ${msg.text.substring(0, 20)}...`;
            document.getElementById('message-input').focus();
        }

        function saveMessage(msg, recipientId) {
            const key = `history_${username}_${recipientId || 'main'}`;
            const history = JSON.parse(localStorage.getItem(key) || '[]');
            history.push(msg);
            localStorage.setItem(key, JSON.stringify(history));
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(`history_${username}_main`) || '[]');
            history.forEach(msg => handleMessage(msg, document.getElementById('chat-area').querySelector('.chat-content'), false));
        }

        function loadDMHistory(recipientId) {
            const history = JSON.parse(localStorage.getItem(`history_${username}_${recipientId}`) || '[]');
            history.forEach(msg => handleMessage(msg, dmTabs[recipientId].chat, true));
        }

        function updateColorStyle() {
            document.documentElement.style.setProperty('--user-color', userColor);
            document.documentElement.style.setProperty('--username-color', userColor);
            document.documentElement.style.setProperty('--user-color-light', lightenColor(userColor, 10));
        }

        function lightenColor(hex, percent) {
            let r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
            r = Math.min(255, Math.floor(r + (255 - r) * (percent / 100)));
            g = Math.min(255, Math.floor(g + (255 - g) * (percent / 100)));
            b = Math.min(255, Math.floor(b + (255 - b) * (percent / 100)));
            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
        }

        loadHistory();
    </script>
</body>
</html>