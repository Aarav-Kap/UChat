<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ulis Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Chalkboard', 'Comic Sans MS', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        body::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            width: 80px;
            height: 80px;
            background-image: url('https://raw.githubusercontent.com/Aarav-Kap/Uchat/main/ulis-logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.1;
            z-index: 1;
        }
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #004d99;
            border-radius: 5px;
            background-color: #2f2f2f;
            margin: 10px;
            position: relative;
            z-index: 2;
        }
        #messages {
            list-style-type: none;
            padding: 10px;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
            border-bottom: 1px solid #004d99;
        }
        #messages li {
            padding: 8px;
            margin: 5px 0;
            background-color: #4a4a4a;
            border-radius: 3px;
            word-wrap: break-word;
            position: relative;
        }
        #messages li.dm {
            background-color: #3a3a3a;
            border-left: 4px solid #0066cc;
        }
        #messages li.reply {
            margin-left: 20px;
            border-left: 2px solid #0066cc;
        }
        #messages li.system {
            color: #a0a0a0;
            font-style: italic;
            text-align: center;
        }
        #messages li span {
            font-weight: bold;
        }
        #messages li .original {
            font-size: 0.8em;
            color: #a0a0a0;
            display: block;
            margin-top: 4px;
        }
        #messages li img {
            max-width: 200px;
            margin-top: 8px;
            border-radius: 3px;
            display: block;
        }
        #messages li .reply-button {
            position: absolute;
            right: 5px;
            top: 5px;
            padding: 2px 5px;
            font-size: 0.7em;
            background-color: #666;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #messages li .reply-button:hover {
            background-color: #555;
        }
        #reply-preview {
            display: none;
            margin-bottom: 5px;
            padding: 5px;
            background-color: #3a3a3a;
            border-left: 2px solid #0066cc;
            color: #a0a0a0;
        }
        #chatbox {
            display: flex;
            padding: 10px;
            gap: 5px;
            background-color: #2f2f2f;
            flex-wrap: wrap;
            align-items: center;
        }
        #input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #004d99;
            border-radius: 3px;
            outline: none;
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        #color-picker, #language-select, #image-input, #dm-toggle, #recipient-select {
            width: 40px;
            padding: 0;
            border: 1px solid #004d99;
            border-radius: 3px;
            background-color: #3a3a3a;
            cursor: pointer;
        }
        #language-select, #recipient-select {
            width: auto;
            padding: 8px;
        }
        #image-preview {
            max-width: 50px;
            margin-left: 5px;
            display: none;
        }
        #attachment-info {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-left: 5px;
            display: none;
        }
        button {
            padding: 8px 15px;
            border: none;
            background-color: #004d99;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #003366;
        }
        #change-name, #logout {
            padding: 8px 10px;
            font-size: 0.8em;
            background-color: #666;
        }
        #change-name:hover, #logout:hover {
            background-color: #555;
        }
        #typing-indicator {
            padding: 5px 10px;
            font-style: italic;
            color: #a0a0a0;
        }
        #user-count {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #004d99;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 2;
        }
        #user-count::before {
            content: 'ðŸ‘¥';
            font-size: 1.2em;
        }
        @media (max-width: 600px) {
            #chat-container {
                margin: 0;
                border: none;
                border-radius: 0;
            }
            #messages {
                min-height: 50vh;
            }
            #chatbox {
                position: sticky;
                bottom: 0;
                gap: 10px;
            }
            #input, #color-picker, #language-select, #image-input, #dm-toggle, #recipient-select {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <ul id="messages"></ul>
        <div id="reply-preview"></div>
        <div id="typing-indicator"></div>
        <form id="chatbox">
            <input id="input" autocomplete="off" placeholder="mr peacock is watching" />
            <input type="color" id="color-picker" value="#007bff" title="Pick your name color" />
            <select id="language-select" title="Receive messages in this language">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="pt">Portuguese</option>
                <option value="hi">Hindi</option>
            </select>
            <input type="file" id="image-input" accept="image/jpeg,image/png,image/gif" title="Attach an image (JPEG, PNG, GIF)" />
            <img id="image-preview" alt="Preview" />
            <span id="attachment-info"></span>
            <input type="checkbox" id="dm-toggle" title="Toggle Direct Message">
            <select id="recipient-select" title="Select recipient" disabled>
                <option value="">All</option>
            </select>
            <button type="button" id="change-name">Change Name</button>
            <a href="/logout"><button type="button" id="logout">Logout</button></a>
            <button type="submit">Send To Ulis!</button>
        </form>
    </div>
    <div id="user-count">0</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Cookie functions (for chat history only)
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Load username from session
        fetch('/username')
            .then(res => res.json())
            .then(data => {
                if (data.username) {
                    username = data.username;
                } else {
                    window.location.href = '/';
                }
            })
            .catch(() => window.location.href = '/');

        let username;

        // Load limited chat history (text only)
        let messagesHistory = [];
        const savedHistory = getCookie('chatHistory');
        if (savedHistory) {
            try {
                messagesHistory = JSON.parse(savedHistory)
                    .filter(msg => msg.text)
                    .slice(-10);
            } catch (e) {
                console.error('Failed to parse chat history:', e);
                messagesHistory = [];
            }
        }

        const socket = io();
        const form = document.getElementById('chatbox');
        const input = document.getElementById('input');
        const colorPicker = document.getElementById('color-picker');
        const languageSelect = document.getElementById('language-select');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const attachmentInfo = document.getElementById('attachment-info');
        const messages = document.getElementById('messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const userCount = document.getElementById('user-count');
        const changeNameButton = document.getElementById('change-name');
        const dmToggle = document.getElementById('dm-toggle');
        const recipientSelect = document.getElementById('recipient-select');
        const replyPreview = document.getElementById('reply-preview');

        // Load history
        messagesHistory.forEach(msg => {
            const li = document.createElement('li');
            const nameSpan = document.createElement('span');
            nameSpan.textContent = msg.username + ': ';
            nameSpan.style.color = msg.color;
            li.appendChild(nameSpan);
            li.appendChild(document.createTextNode(msg.text));
            if (msg.replyTo) {
                li.className = 'reply';
                const replySpan = document.createElement('span');
                replySpan.textContent = `Replying to ${msg.replyTo.username}: ${msg.replyTo.text}`;
                replySpan.style.color = '#a0a0a0';
                li.insertBefore(replySpan, li.firstChild);
            }
            messages.appendChild(li);
        });

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error.message);
        });

        socket.on('user count', (count) => {
            console.log('Received user count:', count);
            userCount.textContent = count;
        });

        socket.on('user list', (users) => {
            recipientSelect.innerHTML = '<option value="">All</option>';
            users.forEach(user => {
                if (user.id !== socket.id) {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    recipientSelect.appendChild(option);
                }
            });
            recipientSelect.disabled = false;
        });

        async function translateText(text, sourceLang, targetLang) {
            if (sourceLang === targetLang) return text;
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`);
                const data = await response.json();
                return data.responseData.translatedText || text;
            } catch (error) {
                console.error('Translation error:', error);
                return text;
            }
        }

        async function detectLanguage(text) {
            return languageSelect.value;
        }

        imageInput.addEventListener('change', () => {
            if (imageInput.files && imageInput.files[0]) {
                const file = imageInput.files[0];
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > 10) {
                    alert('Image too large! Max size is 10MB.');
                    imageInput.value = '';
                    imagePreview.style.display = 'none';
                    attachmentInfo.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imagePreview.style.display = 'inline-block';
                    attachmentInfo.textContent = `Attached: ${file.name} (${fileSizeMB.toFixed(2)}MB)`;
                    attachmentInfo.style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
                attachmentInfo.style.display = 'none';
            }
        });

        let typingTimeout;
        input.addEventListener('input', () => {
            socket.emit('typing', username);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop typing');
            }, 1000);
        });

        changeNameButton.addEventListener('click', () => {
            let newUsername = prompt('Enter your new username (required):', username);
            while (!newUsername || newUsername.trim() === '') {
                newUsername = prompt('Enter your new username (required, cannot be empty):', username);
                if (!newUsername || newUsername.trim() === '') {
                    alert('New username is required!');
                }
            }
            newUsername = newUsername.trim();
            const oldUsername = username;
            username = newUsername;
            fetch('/change-username', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newUsername })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    socket.emit('name change', { oldUsername, newUsername, id: socket.id });
                    const li = document.createElement('li');
                    li.className = 'system';
                    li.textContent = `${oldUsername} changed their name to ${newUsername}`;
                    messages.appendChild(li);
                    messages.scrollTop = messages.scrollHeight;
                } else {
                    alert('Failed to change username: ' + data.message);
                    username = oldUsername;
                }
            });
        });

        dmToggle.addEventListener('change', () => {
            if (dmToggle.checked) {
                recipientSelect.disabled = false;
            } else {
                recipientSelect.disabled = true;
                recipientSelect.value = '';
            }
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = {
                username: username,
                text: input.value || '',
                color: colorPicker.value,
                language: languageSelect.value,
                id: Date.now().toString() // Unique ID for replies
            };

            if (replyTo) {
                message.replyTo = replyTo;
            }

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    message.image = event.target.result;
                    if (dmToggle.checked && recipientSelect.value) {
                        socket.emit('dm message', { ...message, recipientId: recipientSelect.value });
                    } else {
                        socket.emit('chat message', message);
                    }
                    imageInput.value = '';
                    imagePreview.style.display = 'none';
                    attachmentInfo.style.display = 'none';
                    clearReply();
                };
                reader.onerror = () => {
                    alert('Error reading image file!');
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else if (input.value) {
                if (dmToggle.checked && recipientSelect.value) {
                    socket.emit('dm message', { ...message, recipientId: recipientSelect.value });
                } else {
                    socket.emit('chat message', message);
                }
                clearReply();
            }

            input.value = '';
        });

        let replyTo = null;

        function setReply(messageId, replyUsername, replyText) {
            replyTo = { id: messageId, username: replyUsername, text: replyText };
            replyPreview.style.display = 'block';
            replyPreview.textContent = `Replying to ${replyUsername}: ${replyText}`;
            input.focus();
        }

        function clearReply() {
            replyTo = null;
            replyPreview.style.display = 'none';
            replyPreview.textContent = '';
        }

        socket.on('chat message', async (msg) => {
            const targetLang = languageSelect.value;
            const sourceLang = msg.language;
            const translatedText = await translateText(msg.text, sourceLang, targetLang);

            const li = document.createElement('li');
            const nameSpan = document.createElement('span');
            nameSpan.textContent = msg.username + ': ';
            nameSpan.style.color = msg.color;
            li.appendChild(nameSpan);

            if (translatedText) {
                li.appendChild(document.createTextNode(translatedText));
                if (translatedText !== msg.text) {
                    const originalSpan = document.createElement('span');
                    originalSpan.className = 'original';
                    originalSpan.textContent = `(${msg.text})`;
                    li.appendChild(originalSpan);
                }
            }

            if (msg.image) {
                const img = document.createElement('img');
                img.src = msg.image;
                li.appendChild(img);
            }

            if (msg.replyTo) {
                li.className = 'reply';
                const replySpan = document.createElement('span');
                replySpan.textContent = `Replying to ${msg.replyTo.username}: ${msg.replyTo.text}`;
                replySpan.style.color = '#a0a0a0';
                li.insertBefore(replySpan, li.firstChild);
            }

            const replyButton = document.createElement('button');
            replyButton.textContent = 'Reply';
            replyButton.className = 'reply-button';
            replyButton.onclick = () => setReply(msg.id, msg.username, msg.text);
            li.appendChild(replyButton);

            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
            if (msg.text) saveMessage(msg);
        });

        socket.on('dm message', async (msg) => {
            if (msg.recipientId === socket.id) {
                const targetLang = languageSelect.value;
                const sourceLang = msg.language;
                const translatedText = await translateText(msg.text, sourceLang, targetLang);

                const li = document.createElement('li');
                li.className = 'dm';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `[DM] ${msg.username}: `;
                nameSpan.style.color = msg.color;
                li.appendChild(nameSpan);

                if (translatedText) {
                    li.appendChild(document.createTextNode(translatedText));
                    if (translatedText !== msg.text) {
                        const originalSpan = document.createElement('span');
                        originalSpan.className = 'original';
                        originalSpan.textContent = `(${msg.text})`;
                        li.appendChild(originalSpan);
                    }
                }

                if (msg.image) {
                    const img = document.createElement('img');
                    img.src = msg.image;
                    li.appendChild(img);
                }

                if (msg.replyTo) {
                    li.className += ' reply';
                    const replySpan = document.createElement('span');
                    replySpan.textContent = `Replying to ${msg.replyTo.username}: ${msg.replyTo.text}`;
                    replySpan.style.color = '#a0a0a0';
                    li.insertBefore(replySpan, li.firstChild);
                }

                const replyButton = document.createElement('button');
                replyButton.textContent = 'Reply';
                replyButton.className = 'reply-button';
                replyButton.onclick = () => setReply(msg.id, msg.username, msg.text);
                li.appendChild(replyButton);

                messages.appendChild(li);
                messages.scrollTop = messages.scrollHeight;
                if (msg.text) saveMessage(msg);
            }
        });

        socket.on('typing', (username) => {
            typingIndicator.textContent = `${username} is typing...`;
        });

        socket.on('stop typing', () => {
            typingIndicator.textContent = '';
        });

        socket.on('name change', (data) => {
            const li = document.createElement('li');
            li.className = 'system';
            li.textContent = `${data.oldUsername} changed their name to ${data.newUsername}`;
            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
        });

        function saveMessage(msg) {
            messagesHistory.push(msg);
            if (messagesHistory.length > 10) messagesHistory.shift();
            setCookie('chatHistory', JSON.stringify(messagesHistory), 30);
        }
    </script>
</html>