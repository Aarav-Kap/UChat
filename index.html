<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ulis Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Chalkboard', 'Comic Sans MS', sans-serif; /* Schooly font */
            margin: 0;
            padding: 0;
            background-color: #1a1a1a; /* Dark base color */
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            /* Adjusted logo display */
            background-image: url('https://raw.githubusercontent.com/Aarav-Kap/Uchat/main/ulis-logo.png');
            background-repeat: no-repeat;
            background-position: 20px 20px; /* Top-left corner */
            background-size: 100px auto; /* Slightly larger for visibility */
            opacity: 0.3; /* More visible but still subtle */
        }
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #004d99; /* ULIS blue */
            border-radius: 5px;
            background-color: #2a2a2a; /* Darker chat container */
            margin: 10px;
            position: relative;
        }
        #messages {
            list-style-type: none;
            padding: 10px;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
            border-bottom: 1px solid #004d99;
        }
        #messages li {
            padding: 8px;
            margin: 5px 0;
            background-color: #3a3a3a; /* Dark message bubble */
            border-radius: 3px;
            word-wrap: break-word;
        }
        #messages li.system {
            color: #a0a0a0;
            font-style: italic;
            text-align: center;
        }
        #messages li span {
            font-weight: bold;
        }
        #messages li .original {
            font-size: 0.8em;
            color: #a0a0a0;
            display: block;
            margin-top: 4px;
        }
        #messages li img {
            max-width: 200px;
            margin-top: 8px;
            border-radius: 3px;
            display: block;
        }
        #chatbox {
            display: flex;
            padding: 10px;
            gap: 5px;
            background-color: #2a2a2a;
            flex-wrap: wrap;
            align-items: center;
        }
        #input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #004d99;
            border-radius: 3px;
            outline: none;
            background-color: #333;
            color: #e0e0e0;
        }
        #color-picker, #language-select, #image-input {
            width: 40px;
            padding: 0;
            border: 1px solid #004d99;
            border-radius: 3px;
            background-color: #333;
            cursor: pointer;
        }
        #language-select {
            width: auto;
            padding: 8px;
        }
        #image-preview {
            max-width: 50px;
            margin-left: 5px;
            display: none;
        }
        #attachment-info {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-left: 5px;
            display: none;
        }
        button {
            padding: 8px 15px;
            border: none;
            background-color: #004d99;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #003366;
        }
        #change-name {
            padding: 8px 10px;
            font-size: 0.8em;
            background-color: #666;
        }
        #change-name:hover {
            background-color: #555;
        }
        #typing-indicator {
            padding: 5px 10px;
            font-style: italic;
            color: #a0a0a0;
        }
        #user-count {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #004d99;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #user-count::before {
            content: 'ðŸ‘¥';
            font-size: 1.2em;
        }
        @media (max-width: 600px) {
            #chat-container {
                margin: 0;
                border: none;
                border-radius: 0;
            }
            #messages {
                min-height: 50vh;
            }
            #chatbox {
                position: sticky;
                bottom: 0;
                gap: 10px;
            }
            #input, #color-picker, #language-select, #image-input {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <ul id="messages"></ul>
        <div id="typing-indicator"></div>
        <form id="chatbox">
            <input id="input" autocomplete="off" placeholder="mr peacock is watching" />
            <input type="color" id="color-picker" value="#007bff" title="Pick your name color" />
            <select id="language-select" title="Receive messages in this language">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="pt">Portuguese</option>
                <option value="hi">Hindi</option>
            </select>
            <input type="file" id="image-input" accept="image/jpeg,image/png,image/gif" title="Attach an image (JPEG, PNG, GIF)" />
            <img id="image-preview" alt="Preview" />
            <span id="attachment-info"></span>
            <button type="button" id="change-name">Change Name</button>
            <button type="submit">Send To Ulis!</button>
        </form>
    </div>
    <div id="user-count">0</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Cookie functions
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Enforce username input
        let username = getCookie('username');
        while (!username) {
            username = prompt('Enter your username (required):');
            if (!username || username.trim() === '') {
                username = null; // Force the loop to continue if empty or canceled
                alert('Username is required!');
            }
        }
        username = username.trim();
        setCookie('username', username, 30);

        const socket = io();
        const form = document.getElementById('chatbox');
        const input = document.getElementById('input');
        const colorPicker = document.getElementById('color-picker');
        const languageSelect = document.getElementById('language-select');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const attachmentInfo = document.getElementById('attachment-info');
        const messages = document.getElementById('messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const userCount = document.getElementById('user-count');
        const changeNameButton = document.getElementById('change-name');

        // Load chat history from cookies
        const savedMessages = getCookie('chatHistory') ? JSON.parse(getCookie('chatHistory')) : [];
        savedMessages.forEach(msg => {
            const li = document.createElement('li');
            if (msg.system) {
                li.className = 'system';
                li.textContent = msg.text;
            } else {
                const nameSpan = document.createElement('span');
                nameSpan.textContent = msg.username + ': ';
                nameSpan.style.color = msg.color;
                li.appendChild(nameSpan);
                if (msg.text) li.appendChild(document.createTextNode(msg.text));
                if (msg.image) {
                    const img = document.createElement('img');
                    img.src = msg.image;
                    li.appendChild(img);
                }
            }
            messages.appendChild(li);
        });

        async function translateText(text, sourceLang, targetLang) {
            if (sourceLang === targetLang) return text;
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`);
                const data = await response.json();
                return data.responseData.translatedText || text;
            } catch (error) {
                console.error('Translation error:', error);
                return text;
            }
        }

        async function detectLanguage(text) {
            return languageSelect.value;
        }

        imageInput.addEventListener('change', () => {
            if (imageInput.files && imageInput.files[0]) {
                const file = imageInput.files[0];
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > 10) { // Reduced to 10MB
                    alert('Image too large! Max size is 10MB.');
                    imageInput.value = '';
                    imagePreview.style.display = 'none';
                    attachmentInfo.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imagePreview.style.display = 'inline-block';
                    attachmentInfo.textContent = `Attached: ${file.name} (${fileSizeMB.toFixed(2)}MB)`;
                    attachmentInfo.style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
                attachmentInfo.style.display = 'none';
            }
        });

        // Typing indicator
        let typingTimeout;
        input.addEventListener('input', () => {
            socket.emit('typing', username);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop typing');
            }, 1000);
        });

        // Change name button
        changeNameButton.addEventListener('click', () => {
            let newUsername = prompt('Enter your new username (required):', username);
            while (!newUsername || newUsername.trim() === '') {
                newUsername = prompt('Enter your new username (required, cannot be empty):', username);
                if (!newUsername || newUsername.trim() === '') {
                    alert('New username is required!');
                }
            }
            newUsername = newUsername.trim();
            const oldUsername = username;
            username = newUsername;
            setCookie('username', username, 30);
            socket.emit('name change', { oldUsername, newUsername });
            const systemMessage = {
                system: true,
                text: `${oldUsername} changed their name to ${newUsername}`
            };
            saveMessage(systemMessage);
            const li = document.createElement('li');
            li.className = 'system';
            li.textContent = systemMessage.text;
            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = {
                username: username,
                text: input.value || '',
                color: colorPicker.value,
                language: languageSelect.value
            };

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    message.image = event.target.result;
                    socket.emit('chat message', message);
                    saveMessage(message);
                    imageInput.value = '';
                    imagePreview.style.display = 'none';
                    attachmentInfo.style.display = 'none';
                };
                reader.onerror = () => {
                    alert('Error reading image file!');
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else if (input.value) {
                socket.emit('chat message', message);
                saveMessage(message);
            }

            input.value = '';
        });

        function saveMessage(msg) {
            savedMessages.push(msg);
            setCookie('chatHistory', JSON.stringify(savedMessages), 30);
        }

        socket.on('chat message', async (msg) => {
            const targetLang = languageSelect.value;
            const sourceLang = msg.language;
            const translatedText = await translateText(msg.text, sourceLang, targetLang);

            const li = document.createElement('li');
            const nameSpan = document.createElement('span');
            nameSpan.textContent = msg.username + ': ';
            nameSpan.style.color = msg.color;
            li.appendChild(nameSpan);

            if (translatedText) {
                li.appendChild(document.createTextNode(translatedText));
                if (translatedText !== msg.text) {
                    const originalSpan = document.createElement('span');
                    originalSpan.className = 'original';
                    originalSpan.textContent = `(${msg.text})`;
                    li.appendChild(originalSpan);
                }
            }

            if (msg.image) {
                const img = document.createElement('img');
                img.src = msg.image;
                li.appendChild(img);
            }

            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
            saveMessage(msg);
        });

        socket.on('typing', (username) => {
            typingIndicator.textContent = `${username} is typing...`;
        });

        socket.on('stop typing', () => {
            typingIndicator.textContent = '';
        });

        socket.on('user count', (count) => {
            userCount.textContent = count;
        });

        socket.on('name change', (data) => {
            const systemMessage = {
                system: true,
                text: `${data.oldUsername} changed their name to ${data.newUsername}`
            };
            saveMessage(systemMessage);
            const li = document.createElement('li');
            li.className = 'system';
            li.textContent = systemMessage.text;
            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
        });
    </script>
</body>
</html>