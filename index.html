<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dark Chatroom</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #2a2a2a;
            margin: 10px;
        }
        #messages {
            list-style-type: none;
            padding: 10px;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
            border-bottom: 1px solid #333;
        }
        #messages li {
            padding: 8px;
            margin: 5px 0;
            background-color: #3a3a3a;
            border-radius: 3px;
            word-wrap: break-word;
        }
        #messages li span {
            font-weight: bold;
        }
        #messages li .original {
            font-size: 0.8em;
            color: #a0a0a0;
            display: block;
            margin-top: 4px;
        }
        #messages li img {
            max-width: 200px;
            margin-top: 8px;
            border-radius: 3px;
            display: block;
        }
        #chatbox {
            display: flex;
            padding: 10px;
            gap: 5px;
            background-color: #2a2a2a;
            flex-wrap: wrap;
        }
        #input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 3px;
            outline: none;
            background-color: #333;
            color: #e0e0e0;
        }
        #color-picker, #language-select, #image-input {
            width: 40px;
            padding: 0;
            border: 1px solid #444;
            border-radius: 3px;
            background-color: #333;
            cursor: pointer;
        }
        #language-select {
            width: auto;
            padding: 8px;
        }
        #image-preview {
            max-width: 50px;
            margin-left: 5px;
            display: none;
        }
        #attachment-info {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-left: 5px;
            display: none;
        }
        button {
            padding: 8px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        @media (max-width: 600px) {
            #chat-container {
                margin: 0;
                border: none;
                border-radius: 0;
            }
            #messages {
                min-height: 50vh;
            }
            #chatbox {
                position: sticky;
                bottom: 0;
                gap: 10px;
            }
            #input, #color-picker, #language-select, #image-input {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <ul id="messages"></ul>
        <form id="chatbox">
            <input id="input" autocomplete="off" placeholder="Type in your chosen language..." />
            <input type="color" id="color-picker" value="#007bff" title="Pick your name color" />
            <select id="language-select" title="Receive messages in this language">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="pt">Portuguese</option>
                <option value="hi">Hindi</option>
            </select>
            <input type="file" id="image-input" accept="image/jpeg,image/png,image/gif" title="Attach an image (JPEG, PNG, GIF)" />
            <img id="image-preview" alt="Preview" />
            <span id="attachment-info"></span>
            <button>Send</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let username = prompt('Enter your username:') || 'Anonymous';
        const socket = io();
        const form = document.getElementById('chatbox');
        const input = document.getElementById('input');
        const colorPicker = document.getElementById('color-picker');
        const languageSelect = document.getElementById('language-select');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const attachmentInfo = document.getElementById('attachment-info');
        const messages = document.getElementById('messages');

        async function translateText(text, sourceLang, targetLang) {
            if (sourceLang === targetLang) return text;
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`);
                const data = await response.json();
                return data.responseData.translatedText || text;
            } catch (error) {
                console.error('Translation error:', error);
                return text;
            }
        }

        async function detectLanguage(text) {
            return languageSelect.value;
        }

        imageInput.addEventListener('change', () => {
            if (imageInput.files && imageInput.files[0]) {
                const file = imageInput.files[0];
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > 30) { // Increased to 30MB
                    alert('Image too large! Max size is 30MB.');
                    imageInput.value = '';
                    imagePreview.style.display = 'none';
                    attachmentInfo.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imagePreview.style.display = 'inline-block';
                    attachmentInfo.textContent = `Attached: ${file.name} (${fileSizeMB.toFixed(2)}MB)`;
                    attachmentInfo.style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
                attachmentInfo.style.display = 'none';
            }
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = {
                username: username,
                text: input.value || '',
                color: colorPicker.value,
                language: languageSelect.value
            };

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    message.image = event.target.result;
                    try {
                        socket.emit('chat message', message);
                        imageInput.value = '';
                        imagePreview.style.display = 'none';
                        attachmentInfo.style.display = 'none';
                    } catch (error) {
                        alert('Failed to send image! It might be too large or there was a network error.');
                    }
                };
                reader.onerror = () => {
                    alert('Error reading image file!');
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else if (input.value) {
                socket.emit('chat message', message);
            }

            input.value = '';
        });

        socket.on('chat message', async (msg) => {
            const targetLang = languageSelect.value;
            const sourceLang = msg.language;
            const translatedText = await translateText(msg.text, sourceLang, targetLang);

            const li = document.createElement('li');
            const nameSpan = document.createElement('span');
            nameSpan.textContent = msg.username + ': ';
            nameSpan.style.color = msg.color;
            li.appendChild(nameSpan);

            if (translatedText) {
                li.appendChild(document.createTextNode(translatedText));
                if (translatedText !== msg.text) {
                    const originalSpan = document.createElement('span');
                    originalSpan.className = 'original';
                    originalSpan.textContent = `(${msg.text})`;
                    li.appendChild(originalSpan);
                }
            }

            if (msg.image) {
                const img = document.createElement('img');
                img.src = msg.image;
                li.appendChild(img);
            }

            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
        });
    </script>
</body>
</html>